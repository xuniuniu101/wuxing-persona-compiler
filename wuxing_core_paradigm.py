"""
《五行.浮生.我身》人格编译引擎 - 结构范式版 (适配新八字)
八字案例：庚申 丁亥 丙戌 己丑
"""

class 五行人格编译引擎:
    def __init__(self, 八字: str):
        self.八字 = 八字
        self.格局落位 = self._析格局落位()
        self.五行象外 = self._析五行象外()

    # === **格局落位** ===
    def _析格局落位(self) -> dict:
        """核心格局析辩：金水相涵的涤荡之格"""
        四柱 = self.八字.split()
        # 核心特征：年柱庚申（强金），月柱丁亥（水火），日主丙火，时柱己丑（湿土）。
        # 金（庚申）生水（亥），水（亥）克火（丙），土（己丑）晦火生金，形成“金水荡火，土来通关”的复杂局面。
        金水之力 = sum(1 for 柱 in 四柱 if 柱[0] in ['庚', '辛', '壬', '癸'] or 柱[1] in ['申', '酉', '亥', '子'])
        火土之力 = sum(1 for 柱 in 四柱 if 柱[0] in ['丙', '丁', '戊', '己'] or 柱[1] in ['巳', '午', '辰', '戌', '丑', '未'])

        if 金水之力 >= 3 and 火土之力 >= 2:
            return {
                "名称": "财杀涤荡格·土为枢纽",
                "中心议题": "庚申金水（财杀）对丙火（日主）的涤荡与己丑湿土（伤官）的转化",
                "能量楚调": "以坤土为堰，蓄渊海之水以养金锋；借丁火为灯，照湿浊之气而生暖意"
            }
        return {"名称": "伤官格", "中心议题": "五行力量制衡", "能量楚调": "和光同尘，与时舒卷"}

    # === **五行象外** ===
    def _析五行象外(self) -> list:
        """拆解格局中的五行力量，定义其十神与表征"""
        return [
            {
                "五行": "庚申之金",
                "十神": "偏财 | 资源洪流 | 价值尺度",
                "表征": ["大宗资源运作模式", "价值系统的冷峻审视", "压力下的资本嗅觉"],
                "强度": 0.88
            },
            {
                "五行": "月亥之水",
                "十神": "七杀 | 制度深潭 | 规则压力",
                "表征": ["体制性压力承载", "隐性规则解码能力", "危机下的情绪深海"],
                "强度": 0.82
            },
            {
                "五行": "丙丁之火",
                "十神": "日主劫财 | 文明火种 | 协作光源",
                "表征": ["群体中的能量节点", "共识塑造与影响力扩散", "在湿冷环境中的保暖机制"],
                "强度": 0.70
            },
            {
                "五行": "己丑戌土",
                "十神": "伤官食神 | 混沌沃土 | 生化中枢",
                "表征": ["复杂情绪的堆肥与转化", "抽象价值的具象化封装", "在对抗中寻找共生点的智慧"],
                "强度": 0.78
            }
        ]

    # === **应人表达** ===
    def _生成应人表达(self, 五行项: dict) -> dict:
        """将五行属性翻译为具体的人格表达"""
        映射表 = {
            "庚申之金": {
                "心灵基模": "金库审计官",
                "应事接机": "对价值流动有着雷达般的直觉，擅长在复杂的系统（金生水）中评估、调配资源，将压力转化为扩张的资本。",
                "天赋预警": "对资源的敏锐可能异化为对一切关系的功利化计算，需守护非功利的情感绿洲。"
            },
            "月亥之水": {
                "心灵基模": "深水区测绘师",
                "应事接机": "能长期浸润在高压与复杂的规则（水）中而不被淹没，反而绘制出常人看不见的暗流地形图，并学会在其中航行。",
                "天赋预警": "过度适应深水区可能导致对‘正常压力’的误判，或将他人简单的善意解读为复杂博弈。"
            },
            "丙丁之火": {
                "心灵基模": "潮湿地带的篝火",
                "应事接机": "其热情（火）并非烈日当空，而是在湿冷（水）环境中提供不可或缺的聚焦点与温暖，擅长凝聚共识、照亮局部。",
                "天赋预警":  "火光易被湿气（压力）压抑，需警惕能量内耗或忽明忽暗，需找到稳定的燃料（土来通关）。"
            },
            "己丑戌土": {
                "心灵基模": "沼泽哲学家",
                "应事接机":  "思想如肥沃的混沌之土，擅长将最矛盾对立的体验（金水克火）沉淀、发酵，转化为富有营养的洞察与创造性的解决方案。",
                "天赋预警":  "沉溺于思想的复杂性可能延缓行动，需在‘沃土’与‘行动路径’之间架设桥梁。"
            }
        }
        基础 = 映射表.get(五行项["五行"], {})
        return {
            **基础,
            "五行强度": f"{五行项['强度']:.0%}",
            "诗化封装": self._诗化封装(五行项["五行"], 五行项["十神"])
        }

    def _诗化封装(self, 五行: str, 十神: str) -> str:
        """《五行.浮生.我身》文采核心体现"""
        诗典 = {
            "庚申之金": "金鸣于渊，不激不越——价值的回响在深水中传播得更远，每一分压力都折算成未来的信用额度。",
            "月亥之水": "水静流深，自成律法——真正的规则从不喧哗，它只沉默地塑造所有航行的成本与方向。",
            "丙丁之火": "火暖浊水，光分幽暗——最重要的不是熊熊燃烧，而是在最需要光的地方，保持不灭。",
            "己丑戌土": "土纳泾渭，生化无言——它不分辨清流与浊浪，只负责让所有经过的，都长出点什么。"
        }
        return 诗典.get(五行, "")

    # === **内核驱动** ===
    def _推导内核驱动(self) -> dict:
        """从以上分析中提炼出的核心驱动公式与成长逻辑"""
        金 = next((i for i in self.五行象外 if "金" in i["五行"]), None)
        水 = next((i for i in self.五行象外 if "水" in i["五行"]), None)
        土 = next((i for i in self.五行象外 if "土" in i["五行"]), None)
        火 = next((i for i in self.五行象外 if "火" in i["五行"]), None)

        if all([金, 水, 土, 火]):
            # 核心公式：资源(金)与压力(水)通过智慧(土)的转化，为影响力(火)供能
            系统通量 = (金["强度"] * 水["强度"]) * 土["强度"] / (火["强度"] + 0.1)
            return {
                "核心公式": f"资源流({金['强度']:.0%}) × 压力流({水['强度']:.0%}) × 转化率({土['强度']:.0%}) ÷ 能耗({火['强度']:.0%}) ≈ 系统心智通量({系统通量:.1f})",
                "成长逻辑": "庞大的外部资源与规则压力（金水），必须经由你内在的混沌智慧（己丑土）进行生化处理，才能转化为可持续照耀他人的能量（丙火），而非被其吞噬或熄灭。",
                "终极指令": "不是成为永不熄灭的太阳，而是成为一座有自我生化系统的湿地——让流入的（金水）和燃烧的（火），都在你这里转化为新的生命形式。"
            }
        return {"核心公式": "待解析", "成长逻辑": "", "终极指令": ""}

    # === 总控编译函数 ===
    def 编译报告(self) -> dict:
        """生成符合范式的完整报告"""
        内核 = self._推导内核驱动()
        报告 = {
            "范式": "《五行.浮生.我身》人格结构范式报告",
            "输入": self.八字,
            "**格局落位**": self.格局落位,
            "**五行象外与应人表达**": [],
            "**内核驱动**": 内核
        }

        for 象外 in self.五行象外:
            合并项 = {
                "五行象外": {
                    "五行": 象外["五行"],
                    "十神": 象外["十神"],
                    "表征": 象外["表征"],
                    "强度": f"{象外['强度']:.0%}"
                },
                "应人表达": self._生成应人表达(象外)
            }
            报告["**五行象外与应人表达**"].append(合并项)

        return 报告

# === 输出函数 ===
def 打印范式报告(报告: dict):
    """结构化打印报告，五行象外与应人表达上下自然排列"""
    print()
    print(报告["范式"])
    print(f"输入八字: {报告['输入']}")
    print()

    # 打印**格局落位**
    格 = 报告["**格局落位**"]
    print("**格局落位**")
    print(f"  名称: {格.get('名称', 'N/A')}")
    print(f"  中心议题: {格.get('中心议题', 'N/A')}")
    print(f"  能量楚调: {格.get('能量楚调', 'N/A')}")
    print()

    # 打印合并模块：**五行象外** 与 **应人表达** (上下自然排列)
    print("**五行象外 & 应人表达**")
    for 项 in 报告["**五行象外与应人表达**"]:
        print()
        # 1. 打印“五行象外”部分
        维 = 项["五行象外"]
        print(f"  ☯ 五行: {维['五行']} ({维['强度']})")
        print(f"  十神: {维['十神']}")
        print(f"  表征: {' | '.join(维['表征'][:2])}")
        
        # 2. 直接打印“应人表达”部分，自然承接
        表 = 项["应人表达"]
        print(f"  心灵基模: {表.get('心灵基模', 'N/A')}")
        print(f"  应事接机: {表.get('应事接机', 'N/A')}")
        print(f"  诗化封装: {表.get('诗化封装', 'N/A')}")
    print()

    # 打印**内核驱动**
    核 = 报告["**内核驱动**"]
    print("**内核驱动**")
    print(f"  核心公式: {核.get('核心公式', 'N/A')}")
    print(f"  成长逻辑: {核.get('成长逻辑', 'N/A')}")
    print(f"  终极指令: {核.get('终极指令', 'N/A')}")
    print()
    print("古人天人合一之五行计算，宇宙一隅之取模")

# === 运行示例（含交互输入）===
if __name__ == "__main__":
    import sys

    # 处理命令行输入
    if len(sys.argv) > 1:
        用户输入 = " ".join(sys.argv[1:])
    else:
        # 交互模式，预设新八字为例
        print("《五行.浮生.我身》人格编译引擎 - 新案例【庚申 丁亥 丙戌 己丑】")
        print("当前示例八字：庚申 丁亥 丙戌 己丑")
        用户输入 = input("请输入您的八字（直接回车使用示例）: ").strip()
        if not 用户输入:
            用户输入 = "庚申 丁亥 丙戌 己丑"

    # 执行分析
    try:
        引擎 = 五行人格编译引擎(用户输入)
        报告 = 引擎.编译报告()
        打印范式报告(报告)
    except Exception as e:
        print(f"\n❌ 分析失败：{e}")
        print("💡 请确认输入格式为：天干地支 天干地支 天干地支 天干地支")